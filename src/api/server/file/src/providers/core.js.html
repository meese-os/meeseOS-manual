<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <base data-ice="baseUrl" href="../../../">
  <title data-ice="title">src/providers/core.js | meeseOS Server API</title>
  <link type="text/css" rel="stylesheet" href="css/style.css">
  <link type="text/css" rel="stylesheet" href="css/prettify-tomorrow.css">
  <script src="script/prettify/prettify.js"></script>
  <script src="script/manual.js"></script>
<meta name="description" content="meeseOS Server API Documentation"><meta property="twitter:card" content="summary"><meta property="twitter:title" content="meeseOS Server API"><meta property="twitter:description" content="meeseOS Server API Documentation"></head>
<body class="layout-container" data-ice="rootContainer">

<header>
  <a href="./">Home</a>
  
  <a href="identifiers.html">Reference</a>
  <a href="source.html">Source</a>
  
  <div class="search-box">
  <span>
    <img src="./image/search.png">
    <span class="search-input-edge"></span><input class="search-input"><span class="search-input-edge"></span>
  </span>
    <ul class="search-result"></ul>
  </div>
<a style="position:relative; top:3px;" href="https://github.com/meese-os/meeseOS.git"><img width="20px" src="./image/github.png"></a></header>

<nav class="navigation" data-ice="nav"><div>
  <ul>
    
  <li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/core.js~Core.html">Core</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/package.js~Package.html">Package</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/packages.js~Packages.html">Packages</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/settings.js~Settings.html">Settings</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-CoreBase">CoreBase</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-typedef">T</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-PackageMetadata">PackageMetadata</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-typedef">T</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-PackageOptions">PackageOptions</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-typedef">T</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-PackagesOptions">PackagesOptions</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-typedef">T</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-SettingsAdapter">SettingsAdapter</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-typedef">T</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-SettingsOptions">SettingsOptions</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#adapters-auth">adapters/auth</a><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-null">null</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#adapters-settings">adapters/settings</a><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-fs">fs</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-null">null</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#providers">providers</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/providers/auth.js~AuthServiceProvider.html">AuthServiceProvider</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/providers/core.js~CoreServiceProvider.html">CoreServiceProvider</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/providers/packages.js~PackageServiceProvider.html">PackageServiceProvider</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/providers/settings.js~SettingsServiceProvider.html">SettingsServiceProvider</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/providers/token-factory.js~TokenFactoryServiceProvider.html">TokenFactoryServiceProvider</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/providers/token-storage.js~TokenStorageServiceProvider.html">TokenStorageServiceProvider</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/providers/vfs.js~VFSServiceProvider.html">VFSServiceProvider</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-ServiceProvider">ServiceProvider</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#utils">utils</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/utils/token-factory.js~TokenFactory.html">TokenFactory</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/utils/token-storage.js~TokenStorage.html">TokenStorage</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-checkMountpointPermission">checkMountpointPermission</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-createError">createError</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-getPrefix">getPrefix</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-mountpointResolver">mountpointResolver</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-parseFields">parseFields</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-sanitize">sanitize</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-streamFromRequest">streamFromRequest</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-validateGroups">validateGroups</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-errorCodes">errorCodes</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-methodArguments">methodArguments</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-typedef">T</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-TokenFactoryOptions">TokenFactoryOptions</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-typedef">T</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-TokenStorageOptions">TokenStorageOptions</a></span></span></li>
</ul>
</div>
</nav>

<div class="content" data-ice="content"><h1 data-ice="title">src/providers/core.js</h1>
<pre class="source-code line-number raw-source-code"><code class="prettyprint linenums" data-ice="content">/**
 * OS.js - JavaScript Cloud/Web Desktop Platform
 *
 * Copyright (c) 2011-Present, Anders Evenrud &lt;andersevenrud@gmail.com&gt;
 * All rights reserved.
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions are met:
 *
 * 1. Redistributions of source code must retain the above copyright notice, this
 *    list of conditions and the following disclaimer
 * 2. Redistributions in binary form must reproduce the above copyright notice,
 *    this list of conditions and the following disclaimer in the documentation
 *    and/or other materials provided with the distribution
 *
 * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS &quot;AS IS&quot; AND
 * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED
 * WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
 * DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE LIABLE FOR
 * ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES
 * (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES;
 * LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND
 * ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS
 * SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 *
 * @author  Anders Evenrud &lt;andersevenrud@gmail.com&gt;
 * @licence Simplified BSD License
 */

const path = require(&quot;path&quot;);
const express = require(&quot;express&quot;);
const chokidar = require(&quot;chokidar&quot;);
const bodyParser = require(&quot;body-parser&quot;);
const helmet = require(&quot;helmet&quot;);
const proxy = require(&quot;express-http-proxy&quot;);
const nocache = require(&quot;nocache&quot;);
const { ServiceProvider } = require(&quot;@meese-os/common&quot;);
const {
	useWebTokens,
	isAuthenticated,
	closeWatches
} = require(&quot;../utils/core.js&quot;);

/**
 * MeeseOS Core Service Provider
 */
class CoreServiceProvider extends ServiceProvider {
	/**
	 * Create new instance.
	 * @param {Core} core MeeseOS Core instance reference
	 * @param {Object} [options] Arguments
	 */
	constructor(core, options) {
		super(core, options);

		/**
		 * @type {Array}
		 */
		this.watches = [];
	}

	/**
	 * Initializes provider.
	 */
	init() {
		this.initService();
		this.initExtensions();
		this.initResourceRoutes();
		this.initSocketRoutes();
		this.initProxies();
	}

	/**
	 * Starts provider.
	 */
	start() {
		if (this.core.configuration.development) {
			this.initDeveloperTools();
		}
	}

	/**
	 * Get a list of services this provider registers.
	 * @returns {String[]}
	 */
	static provides() {
		return [&quot;meeseOS/express&quot;];
	}

	/**
	 * Destroys provider.
	 */
	async destroy() {
		await closeWatches(this.watches);
		super.destroy();
	}

	/**
	 * Initializes the service APIs.
	 */
	initService() {
		const { app } = this.core;
		const { requireAllGroups } = this.core.configuration.auth;

		const middleware = {
			route: [],
			routeAuthenticated: [],
		};

		this.core.singleton(&quot;meeseOS/express&quot;, () =&gt; ({
			useWebTokens,
			isAuthenticated,

			call: (method, ...args) =&gt; app[method](...args),
			use: (arg) =&gt; app.use(arg),

			websocket: (p, cb) =&gt; app.ws(p, cb),

			middleware: (authentication, cb) =&gt; {
				middleware[authentication ? &quot;routeAuthenticated&quot; : &quot;route&quot;].push(cb);
			},

			route: (method, uri, cb) =&gt;
				app[method.toLowerCase()](uri, [...middleware.route], cb),

			routeAuthenticated: (
				method,
				uri,
				cb,
				groups = [],
				strict = requireAllGroups
			) =&gt;
				app[method.toLowerCase()](
					uri,
					[
						...middleware.routeAuthenticated,
						useWebTokens(app),
						isAuthenticated(groups, strict)
					],
					cb
				),

			router: () =&gt; {
				const router = express.Router();
				router.use(...middleware.route);
				return router;
			},

			routerAuthenticated: (groups = [], strict = requireAllGroups) =&gt; {
				const router = express.Router();
				router.use(...middleware.routeAuthenticated);
				router.use(useWebTokens(app));
				router.use(isAuthenticated(groups, strict));
				return router;
			},
		}));
	}

	/**
	 * Initializes Express extensions.
	 */
	initExtensions() {
		const { app, session, configuration } = this.core;
		const limit = configuration.express.maxBodySize;

		const helmetConfig = {
			contentSecurityPolicy: {
				useDefaults: true,
				directives: {
					&quot;default-src&quot;: [&quot;&apos;self&apos;&quot;],
					// Allow the Google Identity Services loader while keeping inline/eval allowances
					// used elsewhere in the app. Consider moving to nonces/hashes later.
					&quot;script-src&quot;: [
						&quot;&apos;self&apos;&quot;,
						&quot;&apos;unsafe-inline&apos;&quot;,
						&quot;&apos;unsafe-eval&apos;&quot;,
						&quot;https://accounts.google.com&quot;,
						&quot;https://apis.google.com&quot;,
						&quot;https://*.gstatic.com&quot;,
					],
					&quot;style-src&quot;: [&quot;&apos;self&apos;&quot;, &quot;&apos;unsafe-inline&apos;&quot;],
					// Permit remote images (e.g., Unsplash wallpapers) in addition to local/data/blob
					&quot;img-src&quot;: [
						&quot;&apos;self&apos;&quot;,
						&quot;data:&quot;,
						&quot;blob:&quot;,
						&quot;https:&quot;,
					],
					// Allow required outbound connections for GIS and similar SDKs
					&quot;connect-src&quot;: [
						&quot;&apos;self&apos;&quot;,
						&quot;https://accounts.google.com&quot;,
						&quot;https://*.googleapis.com&quot;,
						&quot;https://*.gstatic.com&quot;,
						&quot;https://apis.google.com&quot;,
					],
					// Allow embedding external applications without enumerating domains.
					// Keep clickjacking protection via frame-ancestors from Helmet defaults.
					&quot;frame-src&quot;: [
						&quot;&apos;self&apos;&quot;,
						&quot;https:&quot;,
						&quot;blob:&quot;,
						&quot;data:&quot;,
						// Allow http: only in development for local testing
						...(configuration.development ? [&quot;http:&quot;] : []),
					],
				}
			},
			referrerPolicy: { policy: &quot;no-referrer&quot; },
			crossOriginEmbedderPolicy: false,
			// Some OAuth/GIS popup flows require COOP to be disabled
			crossOriginOpenerPolicy: { policy: &quot;unsafe-none&quot; },
			hsts: configuration.development
				? false
				: {
					maxAge: 63072000,
					includeSubDomains: true,
					preload: true,
				},
		};

		app.use(helmet(helmetConfig));

		if (configuration.development) {
			app.use(nocache());
		} else {
			app.disable(&quot;x-powered-by&quot;);
		}

		// Handle sessions
		app.use(session);

		// Handle bodies
		app.use(
			bodyParser.urlencoded({
				extended: false,
				limit,
			})
		);

		app.use(
			bodyParser.json({
				limit,
			})
		);

		app.use(
			bodyParser.raw({
				limit,
			})
		);
	}

	/**
	 * Initializes Express base routes, etc.
	 */
	initResourceRoutes() {
		const { app, configuration } = this.core;
		const indexFile = path.join(configuration.public, configuration.index);

		app.get(&quot;/&quot;, (req, res) =&gt; res.sendFile(indexFile));
		app.use(&quot;/&quot;, express.static(configuration.public));

		// Internal ping
		app.get(&quot;/ping&quot;, (req, res) =&gt; {
			this.core.emit(&quot;meeseOS/core:ping&quot;, req);

			try {
				req.session.touch();
			} catch (e) {
				this.core.logger.warn(e);
			}

			res.status(200).send(&quot;ok&quot;);
		});
	}

	/**
	 * Initializes Socket routes.
	 */
	initSocketRoutes() {
		const { app } = this.core;

		app.ws(&quot;/&quot;, (ws, req) =&gt; {
			ws.upgradeReq = ws.upgradeReq || req;
			ws._meeseOS_client = { ...req.session.user };

			const interval = this.core.config(&quot;ws.ping&quot;, 0);

			const pingInterval = interval
				? setInterval(() =&gt; {
					ws.send(
						JSON.stringify({
							name: &quot;meeseOS/core:ping&quot;,
						})
					);
				}, interval)
				: undefined;

			ws.on(&quot;close&quot;, () =&gt; {
				clearInterval(pingInterval);
			});

			ws.on(&quot;message&quot;, (msg) =&gt; {
				try {
					const { name, params } = JSON.parse(msg);

					if (typeof name === &quot;string&quot; &amp;&amp; params instanceof Array) {
						// We don&apos;t wanna allow any internal signals from the outside!
						if (
							name.match(/^meeseOS/) &amp;&amp;
							name !== &quot;meeseOS/application:socket:message&quot;
						) {
							return;
						}

						this.core.emit(name, ws, ...params);
					}
				} catch (e) {
					this.core.logger.warn(e);
				}
			});

			ws.send(
				JSON.stringify({
					name: &quot;meeseOS/core:connected&quot;,
					params: [
						{
							cookie: {
								maxAge: this.core.config(&quot;session.options.cookie.maxAge&quot;),
							},
						},
					],
				})
			);
		});
	}

	/**
	 * Initializes Express proxies.
	 */
	initProxies() {
		const { app, configuration } = this.core;
		const proxies = (configuration.proxy || [])
			.map((item) =&gt; ({
				source: null,
				destination: null,
				options: {},
				...item,
			}))
			.filter((item) =&gt; item.source &amp;&amp; item.destination);

		proxies.forEach((item) =&gt; {
			this.core.logger.info(`Proxying ${item.source} -&gt; ${item.destination}`);
			app.use(item.source, proxy(item.destination, item.options));
		});
	}

	/**
	 * Initializes some developer features.
	 */
	initDeveloperTools() {
		try {
			const watchdir = path.resolve(this.core.configuration.public);
			const watcher = chokidar.watch(watchdir);

			watcher.on(&quot;change&quot;, (filename) =&gt; {
				// NOTE: &apos;ignored&apos; does not work as expected with callback
				// ignored: str =&gt; str.match(/\.(js|css)$/) === null
				// for unknown reasons
				if (!/\.(js|css)$/i.test(filename)) return;

				const relative = filename.replace(watchdir, &quot;&quot;);
				this.core.broadcast(&quot;meeseOS/dist:changed&quot;, [relative]);
			});

			this.watches.push(watcher);
		} catch (e) {
			this.core.logger.warn(e);
		}
	}
}

module.exports = CoreServiceProvider;
</code></pre>

</div>

<footer class="footer">
  Generated by <a href="https://esdoc.org">ESDoc<span data-ice="esdocVersion">(1.1.0)</span><img src="./image/esdoc-logo-mini-black.png"></a>
</footer>

<script src="script/search_index.js"></script>
<script src="script/search.js"></script>
<script src="script/pretty-print.js"></script>
<script src="script/inherited-summary.js"></script>
<script src="script/test-summary.js"></script>
<script src="script/inner-link.js"></script>
<script src="script/patch-for-local.js"></script>
</body>
</html>
